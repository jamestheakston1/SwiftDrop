<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftDrop | iPhone to Android Transfer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .radar-ring {
            animation: pulse-ring 3s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(37, 99, 235, 0.1);
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .device-node:hover {
            transform: scale(1.05);
            transition: all 0.3s ease;
        }
        .gradient-text {
            background: linear-gradient(90deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        #app-view { display: none; }
        #qrcode img, #landing-qr img { margin: 0 auto; }
        .qr-wrapper {
            position: relative;
            display: inline-block;
        }
        .qr-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 4px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans overflow-x-hidden">

    <div id="landing-view">
        <nav class="fixed top-0 w-full glass z-50 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-xl text-white">
                    <i data-feather="share-2" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">SwiftDrop</span>
            </div>
            <div class="hidden md:flex gap-8 font-medium text-slate-600">
                <a href="#" class="hover:text-blue-600 transition-colors">Cross-Platform</a>
                <a href="#" class="hover:text-blue-600 transition-colors">Security</a>
                <a href="#" class="hover:text-blue-600 transition-colors">Speed</a>
            </div>
            <button onclick="navigateToApp()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all text-sm md:text-base">
                Launch App
            </button>
        </nav>

        <section class="pt-32 pb-20 px-6 max-w-6xl mx-auto flex flex-col items-center text-center">
            <div class="inline-flex items-center gap-2 bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-sm font-bold mb-8">
                <i data-feather="smartphone" class="w-4 h-4"></i>
                iPhone â†” Android Bridge
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tight mb-6 max-w-4xl leading-tight">
                Finally, AirDrop for <span class="gradient-text">Everyone.</span>
            </h1>
            <p class="text-lg md:text-xl text-slate-500 max-w-2xl mb-10">
                The easiest way to move high-res photos and large files from iPhone to Android and back. No cables, no apps, no limits.
            </p>
            <div class="flex flex-col sm:flex-row gap-4 mb-20">
                <button onclick="navigateToApp()" class="bg-slate-900 text-white px-10 py-4 rounded-2xl font-bold text-lg hover:bg-slate-800 transition-all flex items-center gap-2 justify-center">
                    Get Started <i data-feather="arrow-right"></i>
                </button>
                <div class="flex items-center gap-2 text-slate-400 text-sm font-medium px-4">
                    <i data-feather="link-2" class="w-4 h-4"></i>
                    swift-drop.pages.dev
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8 w-full mb-20">
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm text-left">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center mb-6">
                        <i data-feather="repeat"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3">True Cross-Platform</h3>
                    <p class="text-slate-500">Bridging the gap between iOS and Android seamlessly. If it has a browser, it works.</p>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm text-left">
                    <div class="w-12 h-12 bg-green-100 text-green-600 rounded-xl flex items-center justify-center mb-6">
                        <i data-feather="maximize"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3">Instant Link</h3>
                    <p class="text-slate-500">Generate a unique 6-digit code or connection URL to pair devices instantly without typing long IDs.</p>
                </div>
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm text-left">
                    <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center mb-6">
                        <i data-feather="cpu"></i>
                    </div>
                    <h3 class="font-bold text-xl mb-3">Direct Speed</h3>
                    <p class="text-slate-500">Uses your local Wi-Fi bandwidth for the fastest possible transfer speeds between devices.</p>
                </div>
            </div>
        </section>
    </div>

    <div id="app-view">
        <nav class="fixed top-0 w-full glass z-50 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <button onclick="navigateToLanding()" class="p-2 hover:bg-slate-100 rounded-lg mr-2">
                    <i data-feather="chevron-left" class="w-5 h-5"></i>
                </button>
                <div class="bg-blue-600 p-2 rounded-xl text-white">
                    <i data-feather="share-2" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">SwiftDrop P2P</span>
            </div>
            <div class="flex items-center gap-4">
                <div id="connStatus" class="flex items-center gap-2 bg-slate-100 text-slate-500 px-4 py-2 rounded-full text-sm font-medium border border-slate-200">
                    <span id="statusDot" class="w-2 h-2 bg-slate-400 rounded-full"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
        </nav>

        <div id="setupScreen" class="fixed inset-0 z-[60] glass flex items-center justify-center p-6 mt-16 overflow-y-auto">
            <div id="setupContent" class="max-w-md w-full text-center py-10 transition-opacity duration-300">
                <div class="w-20 h-20 bg-blue-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i data-feather="wifi" class="w-10 h-10"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Connect Devices</h1>
                <p class="text-slate-500 mb-8">Scan the code or share the 6-digit code to link your devices.</p>
                
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-3xl border border-slate-200 flex flex-col items-center">
                        <div class="qr-wrapper mb-4">
                            <div id="qrcode" class="p-2 bg-white rounded-xl"></div>
                            <div class="qr-icon">
                                <i data-feather="share-2" class="w-8 h-8 text-blue-600"></i>
                            </div>
                        </div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Your Pairing Link</p>
                        <div class="flex gap-2 w-full">
                            <input id="myCodeDisplay" readonly class="flex-1 bg-slate-50 border-none text-xl font-bold tracking-widest text-center p-3 rounded-xl focus:ring-0" value="------">
                            <button onclick="copyDirectLink()" class="bg-blue-50 text-blue-600 p-3 rounded-xl hover:bg-blue-100 transition-colors">
                                <i data-feather="share" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl border border-slate-200 text-left">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Enter 6-Digit Code</p>
                        <div class="flex gap-2">
                            <input id="peerIdInput" maxlength="6" class="flex-1 bg-slate-50 border-none text-xl font-bold text-center tracking-widest p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="000000">
                            <button id="connectBtn" onclick="connectToPeer()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-medium hover:bg-blue-700 transition-colors">
                                Connect
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="handshakeContent" class="hidden max-w-md w-full text-center py-10 transition-opacity duration-300">
                <div class="spinner mx-auto mb-6"></div>
                <h2 class="text-2xl font-bold mb-2">Securing Connection...</h2>
                <p class="text-slate-500 mb-2">Establishing P2P Tunnel via Supabase</p>
                <div class="text-3xl font-black text-blue-600" id="handshakePercent">0%</div>
                <div class="w-full max-w-[200px] bg-slate-100 h-1.5 rounded-full overflow-hidden mx-auto mt-4">
                    <div id="handshakeProgressBar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <main class="relative h-screen w-full flex flex-col items-center justify-center p-6">
            <div id="radarContainer" class="relative w-full max-w-2xl aspect-square flex items-center justify-center">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="radar-ring absolute w-[30%] aspect-square border border-blue-200 rounded-full"></div>
                    <div class="radar-ring absolute w-[60%] aspect-square border border-blue-200 rounded-full" style="animation-delay: 1s"></div>
                </div>

                <div class="relative z-10 text-center">
                    <div class="w-24 h-24 bg-white rounded-3xl shadow-2xl flex items-center justify-center mx-auto mb-4 border border-slate-100">
                        <i data-feather="smartphone" class="w-10 h-10 text-blue-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold">Drop Hub</h2>
                    <p class="text-slate-500 text-sm" id="peerName">Waiting for connection...</p>
                </div>
                <div id="devices" class="absolute inset-0"></div>
            </div>
        </main>
    </div>

    <div id="transferModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="glass max-w-md w-full rounded-3xl p-8 shadow-2xl scale-95 transition-transform duration-300">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-2xl font-bold">Transfer File</h3>
                    <p class="text-slate-500">P2P Encrypted Channel</p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center hover:border-blue-400 hover:bg-blue-50/50 transition-all cursor-pointer group mb-6">
                <input type="file" id="fileInput" class="hidden" onchange="handleFiles(this.files)">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                    <i data-feather="upload-cloud" class="w-8 h-8"></i>
                </div>
                <p class="font-medium">Drop files here</p>
            </div>
            <div id="transferProgress" class="hidden">
                <div class="flex justify-between text-sm mb-2 font-medium">
                    <span id="progressText" class="text-blue-600">Sending...</span>
                    <span id="percentText">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 glass px-6 py-4 rounded-2xl shadow-lg border border-slate-200 translate-y-32 transition-transform duration-500 flex items-center gap-3 z-[200]">
        <div class="w-2.5 h-2.5 bg-green-500 rounded-full"></div>
        <span id="toastMsg" class="text-sm font-semibold"></span>
    </div>

    <script>
        const SUPABASE_URL = "https://txvnfnjmgqypsivcwfos.supabase.co";
        const SUPABASE_KEY = "sb_publishable_E7bYIhykblJCsyzbalF1-g_-07QbZSj";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let peerConnection;
        let dataChannel;
        let qrCode;
        let localCode = Math.floor(100000 + Math.random() * 900000).toString();
        let handshakeProgressValue = 0;
        let signalChannel;
        const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const APP_URL = window.location.origin;

        function navigateToApp() {
            document.getElementById('landing-view').style.display = 'none';
            document.getElementById('app-view').style.display = 'block';
            if (!qrCode) {
                const connectUrl = `${APP_URL}?connectcode=${localCode}`;
                generateQRCode(connectUrl);
                document.getElementById('myCodeDisplay').value = localCode;
                setupSignalChannel(localCode);
            }
        }

        function navigateToLanding() {
            document.getElementById('app-view').style.display = 'none';
            document.getElementById('landing-view').style.display = 'block';
        }

        function generateQRCode(text) {
            const container = document.getElementById('qrcode');
            container.innerHTML = "";
            qrCode = new QRCode(container, {
                text: text,
                width: 180,
                height: 180,
                colorDark : "#0f172a",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function setupSignalChannel(code) {
            if (signalChannel) signalChannel.unsubscribe();
            
            signalChannel = sb.channel(`signal-${code}`, {
                config: { broadcast: { self: false } }
            })
            .on('broadcast', { event: 'signal' }, async ({ payload }) => {
                if (payload.to && payload.to !== localCode) return;

                if (payload.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    signalChannel.send({
                        type: 'broadcast',
                        event: 'signal',
                        payload: { type: 'answer', answer: answer, from: localCode, to: payload.from }
                    });
                } else if (payload.type === 'answer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(payload.answer));
                } else if (payload.type === 'ice-candidate') {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(payload.candidate));
                    } catch (e) {}
                }
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log("Ready for signals on code:", code);
                }
            });
        }

        function setupWebRTC() {
            peerConnection = new RTCPeerConnection(iceServers);
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && signalChannel) {
                    const targetCode = document.getElementById('peerIdInput').value.trim();
                    signalChannel.send({
                        type: 'broadcast',
                        event: 'signal',
                        payload: { 
                            type: 'ice-candidate', 
                            candidate: event.candidate, 
                            from: localCode,
                            to: targetCode || null
                        }
                    });
                }
            };

            peerConnection.ondatachannel = (event) => {
                dataChannel = event.channel;
                setupDataChannel(dataChannel);
            };

            peerConnection.oniceconnectionstatechange = () => {
                const state = peerConnection.iceConnectionState;
                updateUIStatus(state);
                if (state === 'connected' || state === 'completed') completeHandshakeUI();
            };
        }

        async function connectToPeer() {
            const code = document.getElementById('peerIdInput').value.trim();
            if (code.length !== 6) {
                showToast("Enter a valid code");
                return;
            }
            
            showHandshakeUI();
            
            dataChannel = peerConnection.createDataChannel("fileTransfer");
            setupDataChannel(dataChannel);

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            signalChannel.send({
                type: 'broadcast',
                event: 'signal',
                payload: { type: 'offer', offer: offer, from: localCode, to: code }
            });
        }

        function setupDataChannel(channel) {
            channel.onopen = () => completeHandshakeUI();
            channel.onmessage = handleIncomingData;
            channel.onclose = () => updateUIStatus('disconnected');
        }

        function showHandshakeUI() {
            document.getElementById('setupContent').classList.add('hidden');
            document.getElementById('handshakeContent').classList.remove('hidden');
            handshakeProgressValue = 0;
            const bar = document.getElementById('handshakeProgressBar');
            const text = document.getElementById('handshakePercent');
            
            const interval = setInterval(() => {
                if (handshakeProgressValue < 98) {
                    handshakeProgressValue += 2;
                    text.innerText = `${handshakeProgressValue}%`;
                    bar.style.width = `${handshakeProgressValue}%`;
                }
            }, 100);
            window.handshakeInterval = interval;
        }

        function completeHandshakeUI() {
            if (window.handshakeInterval) clearInterval(window.handshakeInterval);
            document.getElementById('handshakePercent').innerText = `100%`;
            document.getElementById('handshakeProgressBar').style.width = `100%`;
            setTimeout(() => {
                document.getElementById('setupScreen').classList.add('hidden');
                renderDeviceNode();
            }, 500);
        }

        function handleIncomingData(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'file-start') {
                    window.incomingFile = { name: data.name, chunks: [] };
                } else if (data.type === 'file-chunk') {
                    window.incomingFile.chunks.push(data.chunk);
                    if (window.incomingFile.chunks.length === data.totalChunks) {
                        const blob = new Blob(window.incomingFile.chunks.map(c => Uint8Array.from(atob(c), c => c.charCodeAt(0))));
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = window.incomingFile.name;
                        a.click();
                        showToast(`Received: ${window.incomingFile.name}`);
                    }
                }
            } catch (e) {}
        }

        function handleFiles(files) {
            const file = files[0];
            const reader = new FileReader();
            const chunkSize = 16384;
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('transferProgress').classList.remove('hidden');
            reader.onload = async (e) => {
                const buffer = e.target.result;
                const totalChunks = Math.ceil(buffer.byteLength / chunkSize);
                dataChannel.send(JSON.stringify({ type: 'file-start', name: file.name }));
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = buffer.slice(i * chunkSize, (i + 1) * chunkSize);
                    dataChannel.send(JSON.stringify({
                        type: 'file-chunk',
                        chunk: btoa(String.fromCharCode(...new Uint8Array(chunk))),
                        totalChunks: totalChunks
                    }));
                    let p = ((i + 1) / totalChunks) * 100;
                    document.getElementById('progressBar').style.width = `${p}%`;
                    document.getElementById('percentText').innerText = `${Math.round(p)}%`;
                }
                setTimeout(closeModal, 1000);
                showToast("Transfer Complete!");
            };
            reader.readAsArrayBuffer(file);
        }

        function renderDeviceNode() {
            document.getElementById('devices').innerHTML = `
                <div class="device-node absolute top-[15%] left-[50%] -translate-x-1/2 flex flex-col items-center gap-2 cursor-pointer" onclick="openTransfer()">
                    <div class="w-16 h-16 bg-white rounded-2xl shadow-lg flex items-center justify-center border border-slate-100">
                        <i data-feather="smartphone" class="w-7 h-7 text-blue-600"></i>
                    </div>
                    <span class="text-xs font-bold bg-white px-2 py-1 rounded-full shadow-sm border border-slate-50">Peer Linked</span>
                </div>
            `;
            feather.replace();
        }

        function updateUIStatus(state) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (state === 'connected') {
                dot.className = "w-2 h-2 bg-green-500 rounded-full";
                text.innerText = "Connected";
            } else if (state === 'failed' || state === 'disconnected') {
                dot.className = "w-2 h-2 bg-red-500 rounded-full";
                text.innerText = "Disconnected";
            } else {
                dot.className = "w-2 h-2 bg-amber-500 rounded-full";
                text.innerText = "Connecting...";
            }
        }

        function openTransfer() { document.getElementById('transferModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('transferModal').style.display = 'none'; }
        function copyDirectLink() {
            const connectUrl = `${APP_URL}?connectcode=${localCode}`;
            const el = document.createElement('textarea');
            el.value = connectUrl;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("Link Copied!");
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.style.transform = 'translate(-50%, -40px)';
            setTimeout(() => t.style.transform = 'translate(-50%, 128px)', 3000);
        }

        window.onload = () => {
            feather.replace();
            setupWebRTC();
            const params = new URLSearchParams(window.location.search);
            const cc = params.get('connectcode');
            if (cc) {
                navigateToApp();
                document.getElementById('peerIdInput').value = cc;
                setTimeout(connectToPeer, 1500);
            }
        };
    </script>
</body>
</html>
